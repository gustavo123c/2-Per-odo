#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define MAX_FILMES 300
#define MAX_FAVORITOS 20

typedef struct {
    int id;
    char titulo[100];
    char descricao[300];
} Filme;

typedef struct {
    int id;
    char nome[50];
    int filmesFavoritos[MAX_FAVORITOS];
    int qtdFavoritos;
} Usuario;

// Funcoes auxiliares para manipulacao de filmes
void escreverFilme(Filme filme, FILE *arquivo) {
    fwrite(&filme, sizeof(Filme), 1, arquivo);
}

Filme lerFilme(FILE *arquivo) {
    Filme filme;
    fread(&filme, sizeof(Filme), 1, arquivo);
    return filme;
}

void atualizarFilme(Filme filmeNovo, const char *nomeArquivo) {
    FILE *arquivo = fopen(nomeArquivo, "r+b");
    if (!arquivo) {
        printf("Erro ao abrir o arquivo de filmes.\n");
        return;
    }

    Filme filme;
    while (fread(&filme, sizeof(Filme), 1, arquivo)) {
        if (filme.id == filmeNovo.id) {
            fseek(arquivo, -sizeof(Filme), SEEK_CUR);
            fwrite(&filmeNovo, sizeof(Filme), 1, arquivo);
            break;
        }
    }

    fclose(arquivo);
}

void removerFilme(int id, const char *nomeArquivo) {
    FILE *arquivo = fopen(nomeArquivo, "rb");
    if (!arquivo) {
        printf("Erro ao abrir o arquivo de filmes.\n");
        return;
    }

    FILE *temp = fopen("temp.bin", "wb");
    if (!temp) {
        printf("Erro ao criar arquivo temporario.\n");
        fclose(arquivo);
        return;
    }

    Filme filme;
    int encontrado = 0;

    while (fread(&filme, sizeof(Filme), 1, arquivo)) {
        if (filme.id != id) {
            fwrite(&filme, sizeof(Filme), 1, temp);
        } else {
            encontrado = 1;
        }
    }

    fclose(arquivo);
    fclose(temp);

    if (!encontrado) {
        printf("Filme com ID %d nao encontrado.\n", id);
        remove("temp.bin");
        return;
    }

    if (remove(nomeArquivo) != 0 || rename("temp.bin", nomeArquivo) != 0) {
        printf("Erro ao atualizar o arquivo de filmes.\n");
        return;
    }

    printf("Filme com ID %d removido com sucesso!\n", id);
}

// Funcoes auxiliares para manipulacao de usuarios
void escreverUsuario(Usuario usuario, FILE *arquivo) {
    fwrite(&usuario, sizeof(Usuario), 1, arquivo);
}

Usuario lerUsuario(FILE *arquivo) {
    Usuario usuario;
    fread(&usuario, sizeof(Usuario), 1, arquivo);
    return usuario;
}

void atualizarUsuario(Usuario usuarioNovo, const char *nomeArquivoUsuarios) {
    FILE *arquivo = fopen(nomeArquivoUsuarios, "r+b");
    if (!arquivo) {
        printf("Erro ao abrir o arquivo de usuarios.\n");
        return;
    }

    Usuario usuario;
    while (fread(&usuario, sizeof(Usuario), 1, arquivo)) {
        if (usuario.id == usuarioNovo.id) {
            fseek(arquivo, -sizeof(Usuario), SEEK_CUR);
            fwrite(&usuarioNovo, sizeof(Usuario), 1, arquivo);
            break;
        }
    }

    fclose(arquivo);
}

void removerUsuario(int idUsuario, const char *nomeArquivoUsuarios) {
    FILE *arquivoUsuarios = fopen(nomeArquivoUsuarios, "r+b");
    FILE *tempFile = fopen("temp_usuarios.bin", "wb");
    if (!arquivoUsuarios || !tempFile) {
        printf("Erro ao abrir os arquivos.\n");
        return;
    }

    Usuario usuario;
    int usuarioRemovido = 0;

    // Copiar todos os usuarios para o arquivo temporario, exceto o removido
    while (fread(&usuario, sizeof(Usuario), 1, arquivoUsuarios)) {
        if (usuario.id != idUsuario) {
            fwrite(&usuario, sizeof(Usuario), 1, tempFile);
        } else {
            usuarioRemovido = 1;
        }
    }

    if (!usuarioRemovido) {
        printf("Usuario com ID %d nao encontrado.\n", idUsuario);
    } else {
        printf("Usuario com ID %d removido com sucesso.\n", idUsuario);
    }

    fclose(arquivoUsuarios);
    fclose(tempFile);

    // Substituir o arquivo original pelo temporario
    remove(nomeArquivoUsuarios);
    rename("temp_usuarios.bin", nomeArquivoUsuarios);
}

// Funcoes para listar filmes e usuarios
void listarFilmes(const char *nomeArquivo) {
    FILE *arquivo = fopen(nomeArquivo, "rb");
    if (!arquivo) {
        printf("Erro ao abrir o arquivo de filmes.\n");
        return;
    }

    Filme filme;
    printf("Lista de Filmes:\n");
    while (fread(&filme, sizeof(Filme), 1, arquivo)) {
        printf("ID: %d, Titulo: %s, Descricao: %s\n", filme.id, filme.titulo, filme.descricao);
    }

    fclose(arquivo);
}

void listarUsuarios(const char *nomeArquivoUsuarios, const char *nomeArquivoFilmes) {
    FILE *arquivoUsuarios = fopen(nomeArquivoUsuarios, "rb");
    FILE *arquivoFilmes = fopen(nomeArquivoFilmes, "rb");
    if (!arquivoUsuarios || !arquivoFilmes) {
        printf("Erro ao abrir os arquivos de usuarios ou filmes.\n");
        return;
    }

    Usuario usuario;
    Filme filme;
    printf("Lista de Usuarios:\n");

    // Percorrer todos os usuarios no arquivo
    while (fread(&usuario, sizeof(Usuario), 1, arquivoUsuarios)) {
        printf("ID: %d, Nome: %s\n", usuario.id, usuario.nome);
        printf("Filmes Favoritos:\n");

        // Para cada filme favorito, procurar o filme no arquivo de filmes
        for (int i = 0; i < usuario.qtdFavoritos; i++) {
            fseek(arquivoFilmes, 0, SEEK_SET);  // Voltar ao inicio do arquivo de filmes
            while (fread(&filme, sizeof(Filme), 1, arquivoFilmes)) {
                if (filme.id == usuario.filmesFavoritos[i]) {
                    printf("  - ID: %d, Titulo: %s\n", filme.id, filme.titulo);
                    break;  // Encontra o filme e quebra o loop para evitar multipla impressao
                }
            }
        }

        printf("\n");  // Espaco para separacao visual entre usuarios
    }

    fclose(arquivoUsuarios);
    fclose(arquivoFilmes);
}

// Funcao para adicionar filme aos favoritos do usuario
void adicionarFilmeFavorito(int idUsuario, int idFilme, const char *nomeArquivoUsuarios, const char *nomeArquivoFilmes) {
    FILE *arquivoUsuarios = fopen(nomeArquivoUsuarios, "r+b");
    FILE *arquivoFilmes = fopen(nomeArquivoFilmes, "rb");
    if (!arquivoUsuarios || !arquivoFilmes) {
        printf("Erro ao abrir os arquivos de usuarios ou filmes.\n");
        return;
    }

    Usuario usuario;
    Filme filme;
    int usuarioEncontrado = 0;
    int filmeValido = 0;

    // Verificar se o usuario existe
    while (fread(&usuario, sizeof(Usuario), 1, arquivoUsuarios)) {
        if (usuario.id == idUsuario) {
            usuarioEncontrado = 1;
            break;
        }
    }

    // Verificar se o filme existe
    fseek(arquivoFilmes, 0, SEEK_SET);
    while (fread(&filme, sizeof(Filme), 1, arquivoFilmes)) {
        if (filme.id == idFilme) {
            filmeValido = 1;
            break;
        }
    }

    fclose(arquivoFilmes);

    if (!usuarioEncontrado) {
        printf("Usuario com ID %d nao encontrado.\n", idUsuario);
        fclose(arquivoUsuarios);
        return;
    }

    if (!filmeValido) {
        printf("Filme com ID %d nao encontrado.\n", idFilme);
        fclose(arquivoUsuarios);
        return;
    }

    // Adicionar o filme aos favoritos do usuario
    fseek(arquivoUsuarios, -sizeof(Usuario), SEEK_CUR);
    usuario.filmesFavoritos[usuario.qtdFavoritos] = idFilme;
    usuario.qtdFavoritos++;

    fseek(arquivoUsuarios, -sizeof(Usuario), SEEK_CUR);
    fwrite(&usuario, sizeof(Usuario), 1, arquivoUsuarios);

    printf("Filme com ID %d adicionado aos favoritos do usuario %d.\n", idFilme, idUsuario);
    fclose(arquivoUsuarios);
}

// Menu principal
void exibirMenu() {
    printf("\n--- Menu ---\n");
    printf("1. Cadastrar Filme\n");
    printf("2. Cadastrar Usuario\n");
    printf("3. Listar Filmes\n");
    printf("4. Listar Usuarios\n");
    printf("5. Atualizar Filme\n");
    printf("6. Atualizar Usuario\n");
    printf("7. Remover Filme\n");
    printf("8. Remover Usuario\n");
    printf("9. Adicionar Filme aos Favoritos\n");
    printf("0. Sair\n");
    printf("Escolha uma opcao: ");
}

int main() {
    const char *nomeArquivoFilmes = "filmes.bin";
    const char *nomeArquivoUsuarios = "usuarios.bin";

    // Testando as funcionalidades principais
    while (1) {
        exibirMenu();
        int opcao;
        scanf("%d", &opcao);

        switch (opcao) {
            case 1: {
                Filme filme;
                printf("Digite o ID do filme: ");
                scanf("%d", &filme.id);
                printf("Digite o titulo do filme: ");
                getchar(); // Para consumir o newline
                fgets(filme.titulo, sizeof(filme.titulo), stdin);
                printf("Digite a descricao do filme: ");
                fgets(filme.descricao, sizeof(filme.descricao), stdin);

                FILE *arquivoFilmes = fopen(nomeArquivoFilmes, "ab");
                if (arquivoFilmes) {
                    escreverFilme(filme, arquivoFilmes);
                    fclose(arquivoFilmes);
                    printf("Filme cadastrado com sucesso!\n");
                } else {
                    printf("Erro ao abrir arquivo de filmes.\n");
                }
                break;
            }
            case 2: {
                Usuario usuario;
                printf("Digite o ID do usuario: ");
                scanf("%d", &usuario.id);
                printf("Digite o nome do usuario: ");
                getchar(); // Para consumir o newline
                fgets(usuario.nome, sizeof(usuario.nome), stdin);
                usuario.qtdFavoritos = 0;

                FILE *arquivoUsuarios = fopen(nomeArquivoUsuarios, "ab");
                if (arquivoUsuarios) {
                    escreverUsuario(usuario, arquivoUsuarios);
                    fclose(arquivoUsuarios);
                    printf("Usuario cadastrado com sucesso!\n");
                } else {
                    printf("Erro ao abrir arquivo de usuarios.\n");
                }
                break;
            }
            case 3: {
                listarFilmes(nomeArquivoFilmes);
                break;
            }
            case 4: {
                listarUsuarios(nomeArquivoUsuarios, nomeArquivoFilmes);
                break;
            }
            case 5: {
                Filme filmeNovo;
                printf("Digite o ID do filme a ser atualizado: ");
                scanf("%d", &filmeNovo.id);
                printf("Digite o novo titulo do filme: ");
                getchar(); // Para consumir o newline
                fgets(filmeNovo.titulo, sizeof(filmeNovo.titulo), stdin);
                printf("Digite a nova descricao do filme: ");
                fgets(filmeNovo.descricao, sizeof(filmeNovo.descricao), stdin);
                atualizarFilme(filmeNovo, nomeArquivoFilmes);
                break;
            }
            case 6: {
                Usuario usuarioNovo;
                printf("Digite o ID do usuario a ser atualizado: ");
                scanf("%d", &usuarioNovo.id);
                printf("Digite o novo nome do usuario: ");
                getchar(); // Para consumir o newline
                fgets(usuarioNovo.nome, sizeof(usuarioNovo.nome), stdin);
                atualizarUsuario(usuarioNovo, nomeArquivoUsuarios);
                break;
            }
            case 7: {
                int idFilme;
                printf("Digite o ID do filme a ser removido: ");
                scanf("%d", &idFilme);
                removerFilme(idFilme, nomeArquivoFilmes);
                break;
            }
            case 8: {
                int idUsuario;
                printf("Digite o ID do usuario a ser removido: ");
                scanf("%d", &idUsuario);
                removerUsuario(idUsuario, nomeArquivoUsuarios);
                break;
            }
            case 9: {
                int idUsuario, idFilme;
                printf("Digite o ID do usuario: ");
                scanf("%d", &idUsuario);
                printf("Digite o ID do filme a ser adicionado aos favoritos: ");
                scanf("%d", &idFilme);
                adicionarFilmeFavorito(idUsuario, idFilme, nomeArquivoUsuarios, nomeArquivoFilmes);
                break;
            }
            case 0:
                printf("Saindo do programa...\n");
                return 0;
            default:
                printf("Opcao invalida!\n");
        }
    }

    return 0;
}

